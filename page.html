<script>
    // Kontrollera om FFmpeg.js är korrekt laddat
    window.onload = function() {
        if (typeof FFmpeg === 'undefined') {
            alert('FFmpeg.js could not be loaded!');
        } else {
            console.log('FFmpeg.js loaded successfully');
        }
    };

    // Funktioner för knappar och händelser
    document.getElementById('browse-btn').addEventListener('click', function() {
        document.getElementById('file-input').click();
    });

    document.getElementById('change-background-btn').addEventListener('click', function() {
        const backgroundOptions = document.getElementById('background-options');
        backgroundOptions.style.display = (backgroundOptions.style.display === 'block') ? 'none' : 'block';
    });

    document.getElementById('light-mode-btn').addEventListener('click', function() {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        document.getElementById('background-options').style.display = 'none';
    });

    document.getElementById('dark-mode-btn').addEventListener('click', function() {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        document.getElementById('background-options').style.display = 'none';
    });

    document.getElementById('save-btn').addEventListener('click', function() {
        alert('Changes saved!');
    });

    document.getElementById('back-to-home-btn').addEventListener('click', function() {
        window.location.href = 'index.html'; // Navigerar till hemsidan
    });

    // Konvertering och videofunktioner
    async function convertToMP4() {
        document.getElementById('progress-bar').style.display = 'block'; // Visa laddningsbar
        document.getElementById('progress-text').style.display = 'block'; // Visa texten för progress

        try {
            console.log('Initializing FFmpeg');
            const ffmpeg = FFmpeg.createFFmpeg({ log: true });
            await ffmpeg.load(); // Ladda FFmpeg

            console.log('FFmpeg loaded');
            const videoFile = document.getElementById('file-input').files[0];
            if (!videoFile) {
                alert('Please select a video file.');
                return;
            }

            const videoName = videoFile.name;

            // Kolla om filen redan är en MP4-fil
            if (videoFile.type === 'video/mp4') {
                document.getElementById('progress-text').textContent = 'Cannot convert to MP4, your file is already in an MP4 format';
                document.getElementById('progress-bar').style.display = 'none'; // Dölj progressbar
                return; // Stoppa processen om filen är redan en MP4
            }

            await ffmpeg.FS('writeFile', videoName, new Uint8Array(await videoFile.arrayBuffer()));

            const interval = setInterval(() => {
                const progress = (ffmpeg.FS('stat', videoName).size / 1000000) * 100;
                document.getElementById('progress-bar-filled').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `${Math.round(progress)}% of 100% to complete conversion`;

                if (progress === 100) {
                    clearInterval(interval);
                    document.getElementById('progress-text').textContent = 'Conversion successful!';
                    document.getElementById('progress-bar').style.display = 'none'; // Dölj progressbar
                }
            }, 1000);

            // Kör konverteringen till MP4
            await ffmpeg.run('-i', videoName, 'output.mp4');
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            const videoUrl = URL.createObjectURL(videoBlob);
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.src = videoUrl;

        } catch (error) {
            console.error('Error during conversion:', error);
            document.getElementById('progress-text').textContent = 'Failed to convert';
        }
    }
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('file-name').textContent = file.name;
            const videoPlayer = document.getElementById('video-player');
            const videoSource = document.getElementById('video-source');
            videoSource.src = URL.createObjectURL(file);
            videoPlayer.load();  // Uppdaterar videospelaren
        }
    }

    // Volymreglage funktion
    function updateVolumePercentage(type) {
        const volume = document.getElementById(type + '-volume').value;
        document.getElementById(type + '-volume-percent').textContent = volume + '%';
    }

    // Stäng popupen för bakgrundsalternativ när man klickar utanför
    document.addEventListener('click', function(event) {
        const backgroundOptions = document.getElementById('background-options');
        const changeBackgroundBtn = document.getElementById('change-background-btn');
        if (!backgroundOptions.contains(event.target) && event.target !== changeBackgroundBtn) {
            backgroundOptions.style.display = 'none';
        }
    });
</script>
