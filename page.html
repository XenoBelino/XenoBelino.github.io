<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg Video Konverterare</title>
    <!-- Använda den senaste versionen av ffmpeg.js -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 30px;
            background: #f4f4f4;
        }
        video {
            margin-top: 20px;
            width: 80%;
            max-width: 600px;
        }
        #progress-bar {
            width: 100%;
            background: #ccc;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        #progress-bar-filled {
            height: 20px;
            width: 0;
            background: #4caf50;
        }
    </style>
</head>
<body>

    <h1>Konvertera Videoer</h1>

    <input type="file" id="uploader" accept="video/mp4,video/webm,video/avi,video/flv,video/mkv,video/mov"><br><br>
    <button onclick="convertToMP4()">Konvertera</button>

    <div id="progress-bar">
        <div id="progress-bar-filled"></div>
    </div>

    <p id="status"></p>

    <video id="video-player" controls></video><br>
    <button id="download-btn" style="display: none;">Ladda ner MP4</button>

    <script>
        let ffmpeg;

        // Vänta tills FFmpeg har laddats innan vi fortsätter
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const { createFFmpeg } = FFmpeg;
                ffmpeg = createFFmpeg({ log: true });
                await ffmpeg.load();
                console.log("FFmpeg är laddad och klar att användas!");
            } catch (error) {
                console.error("Fel vid inläsning av FFmpeg:", error);
                alert("Det gick inte att ladda FFmpeg! Kontrollera konsolen för mer information.");
            }
        });

        async function convertToMP4() {
            const input = document.getElementById('uploader');
            const file = input.files[0];
            const status = document.getElementById('status');
            const player = document.getElementById('video-player');
            const progressBar = document.getElementById('progress-bar');
            const progressBarFilled = document.getElementById('progress-bar-filled');

            if (!file) {
                alert("Välj en videofil först!");
                return;
            }

            if (!ffmpeg) {
                alert("FFmpeg har inte laddats korrekt. Försök igen.");
                return;
            }

            progressBar.style.display = 'block';
            status.textContent = 'Konverterar...';

            const inputName = file.name;
            const outputName = 'output.mp4';

            try {
                console.log("Laddar fil:", inputName);
                // Skriv filen till FFmpeg filsystem
                await ffmpeg.FS('writeFile', inputName, new Uint8Array(await file.arrayBuffer()));

                // Kör FFmpeg kommandot för att konvertera video
                console.log("Kör FFmpeg konvertering...");
                await ffmpeg.run('-i', inputName, '-c:v', 'libx264', '-crf', '23', outputName);

                // Läs utdatafilen och visa resultatet
                const data = ffmpeg.FS('readFile', outputName);
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoURL = URL.createObjectURL(videoBlob);

                player.src = videoURL;
                document.getElementById('download-btn').style.display = 'inline-block';
                document.getElementById('download-btn').onclick = () => {
                    const a = document.createElement('a');
                    a.href = videoURL;
                    a.download = 'converted-video.mp4';
                    a.click();
                };

                progressBarFilled.style.width = '100%';
                status.textContent = 'Konvertering klar!';
            } catch (err) {
                console.error("Fel under konverteringen:", err);
                status.textContent = 'Fel vid konvertering. Se konsolen för mer info.';
            }
        }
    </script>

</body>
</html>
