<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Video Player with Settings</title>

    <link rel="stylesheet" href="styles.css" />
    <style>
        /* ... (din befintliga CSS, oförändrad) ... */
        /* OBS: Jag har inte ändrat på CSS, så jag klipper här för att fokusera på det viktiga */
    </style>
</head>
<body>
    <div class="editor-content">
        <!-- ... (din befintliga HTML-innehåll, oförändrad) ... -->
        <div id="file-name">No file selected</div>
        <button id="browse-btn" class="browse-button" onclick="triggerFileInput()">Browse Files</button>
        <input type="file" id="file-input" style="display:none;" onchange="handleFileSelect(event)">
        <button id="convert-btn" class="button" onclick="convertToMP4()">Convert to MP4</button>

        <button id="change-background-btn" class="button" onclick="toggleBackgroundOptions()">Change Background</button>
        <button id="save-btn" class="button">Save Changes</button>

        <!-- ... (volymreglage, progress-bar, och bakgrundsinställningar oförändrade) ... -->

        <button id="back-to-home-btn" class="button" onclick="goToHomePage()">Go to Homepage</button>
    </div>

    <!-- ✅ Rätt version av FFmpeg (OBS: dist/ istället för direkt) -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@5.2.0/dist/ffmpeg.min.js"></script>

    <script>
        // ✅ Global felhantering (hjälper vid felsökning)
        window.onerror = function (message, source, lineno, colno, error) {
            alert("Ett fel inträffade: " + message);
            console.error("Script error:", message, source, lineno, colno, error);
        };

        let originalFileName = '';

        function updateVolumePercentage(sliderType) {
            const volumeSlider = document.getElementById(`${sliderType}-volume`);
            const volumePercent = document.getElementById(`${sliderType}-volume-percent`);
            volumePercent.textContent = `${volumeSlider.value}%`;
        }

        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        function handleFileSelect(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            const fileName = file ? file.name : 'No file selected';
            originalFileName = file ? file.name : '';
            document.getElementById('file-name').textContent = fileName;

            document.getElementById('progress-text').style.display = 'none';
            document.getElementById('progress-bar').style.display = 'none';

            const videoPlayer = document.getElementById('video-player');
            const videoUrl = URL.createObjectURL(file);
            videoPlayer.src = videoUrl;
        }

        function toggleBackgroundOptions() {
            const options = document.getElementById('background-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        window.addEventListener('click', function (event) {
            const options = document.getElementById('background-options');
            if (!options.contains(event.target) && !document.getElementById('change-background-btn').contains(event.target)) {
                options.style.display = 'none';
            }
        });

        function setLightMode() {
            document.body.classList.remove('dark-mode');
            toggleBackgroundOptions();
        }

        function setDarkMode() {
            document.body.classList.add('dark-mode');
            toggleBackgroundOptions();
        }

        function goToHomePage() {
            window.location.href = "index.html";
        }

        // ✅ Uppdaterad och fungerande FFmpeg-konvertering
        async function convertToMP4() {
            const file = document.getElementById('file-input').files[0];
            if (!file) {
                alert('Please select a video file.');
                return;
            }

            if (file.name.endsWith('.mp4')) {
                document.getElementById('progress-text').textContent = 'Filen är redan i MP4-format.';
                document.getElementById('progress-text').style.display = 'block';
                return;
            }

            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({ log: true });

            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('progress-text').style.display = 'block';

            ffmpeg.setProgress(({ ratio }) => {
                const percent = Math.round(ratio * 100);
                document.getElementById('progress-bar-filled').style.width = `${percent}%`;
                document.getElementById('progress-text').textContent = `${percent}% av 100% för att slutföra konverteringen`;
            });

            try {
                await ffmpeg.load();

                const inputName = file.name;
                const outputName = 'output.mp4';

                await ffmpeg.FS('writeFile', inputName, await fetchFile(file));
                await ffmpeg.run('-i', inputName, outputName);

                const data = ffmpeg.FS('readFile', outputName);
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);

                const videoPlayer = document.getElementById('video-player');
                videoPlayer.src = videoUrl;

                const downloadFileName = originalFileName.replace(/\.[^/.]+$/, '') + '-converted.mp4';
                document.getElementById('save-btn').addEventListener('click', function () {
                    const a = document.createElement('a');
                    a.href = videoUrl;
                    a.download = downloadFileName;
                    a.click();
                });

                document.getElementById('progress-text').textContent = 'Konvertering klar!';
                document.getElementById('progress-bar').style.display = 'none';

            } catch (err) {
                console.error(err);
                document.getElementById('progress-text').textContent = 'Fel vid konvertering.';
                document.getElementById('progress-bar').style.display = 'none';
            }
        }
    </script>
</body>
</html>
